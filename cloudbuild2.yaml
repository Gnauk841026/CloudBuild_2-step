steps:
- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    set -e
    set -x
    
    # 決定要部署的 image
    if [ -n "$_SPECIFIED_IMAGE" ]; then
      DEPLOY_IMAGE="$_SPECIFIED_IMAGE"
    elif [ -n "$_PUB_SUB_MESSAGE" ]; then
      DEPLOY_IMAGE=$(echo $_PUB_SUB_MESSAGE | python3 -c "import sys, json; print(json.load(sys.stdin)['image'])")
    else
      echo "錯誤：沒有指定要部署的 image"
      exit 1
    fi
    
    echo "正在部署鏡像: $DEPLOY_IMAGE"
    
    # 安裝 SSH 客戶端
    apt-get update && apt-get install -y openssh-client
    
    # 準備 SSH
    mkdir -p /root/.ssh
    chmod 700 /root/.ssh
    gcloud secrets versions access latest --secret=ssh-key > /root/.ssh/id_rsa
    chmod 600 /root/.ssh/id_rsa
    
    # 將 SSH 密鑰添加到 known_hosts
    ssh-keyscan -H 35.234.30.55 >> /root/.ssh/known_hosts
    
    # 連接到 VM 並執行部署腳本
    ssh -i /root/.ssh/id_rsa -o StrictHostKeyChecking=no lucifer_suriel@35.234.30.55 << EOF
      set -e
      set -x
      
      # 檢查並安裝 Docker（如果不存在）
      if ! command -v docker &> /dev/null; then
        echo "未找到 Docker。正在安裝 Docker..."
        sudo apt-get update
        sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
        sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
        sudo apt-get update
        sudo apt-get install -y docker-ce
      fi
      
      # 拉取指定鏡像
      sudo docker pull $DEPLOY_IMAGE
      
      # 停止並移除舊容器（如果存在）
      sudo docker stop hello-js || true
      sudo docker rm hello-js || true
      
      # 運行新容器
      sudo docker run -d --name hello-js -p 80:3000 $DEPLOY_IMAGE
      
      # 顯示正在運行的容器
      sudo docker ps
    EOF

substitutions:
  _PUB_SUB_MESSAGE: ''  # 由 Pub/Sub 觸發器自動填充，手動觸發時留空
  _SPECIFIED_IMAGE: ''  # 用於手動指定部署的 image，例如回滾到特定版本

timeout: '1200s'
options:
  defaultLogsBucketBehavior: REGIONAL_USER_OWNED_BUCKET

